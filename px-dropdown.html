<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../px-polymer-font-awesome/px-polymer-font-awesome.html" />
<link rel="import" href="../iron-dropdown/iron-dropdown.html" />
<link rel="import" href="../iron-selector/iron-selector.html" />
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html" />

<!--
This element provides a dropdown where users can select one or more values.

It can also be used in conjunction with px-validation, similar to px-forms-design, to apply validation states - simply add the `validation-error`, `validation-warning`, and `validation-success` classes to alter the border color of the component.

##### Usage

```
TODO
```

### Styling
The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
TODO

@element px-dropdown
@blurb Element providing a dropdown solution.
@homepage index.html
@demo index.html
-->
<link rel="import" href="css/px-dropdown-styles.html">

<dom-module id="px-dropdown">
  <template>
    <style include="px-dropdown-styles"></style>
    <button id="button" class$="btn dropdown-trigger {{_getDisabledClass(disabled)}} {{_getBareClass(bare)}}" on-tap="toggle">
      <div id="label" class="label">{{displayValue}}</div>
      <template is="dom-if" if="{{_showClearButton(opened,selected,selectedValues,selectedValues.*)}}">
        <iron-icon class="icon" icon="fa:fa-times-circle" on-tap="clear"></iron-icon>
      </template>
      <template is="dom-if" if="{{_showChevron(hideChevron,opened,selected,selectedValues,selectedValues.*)}}">
        <iron-icon class="icon" icon="fa:fa-angle-down"></iron-icon>
      </template>
    </button>
    <iron-dropdown id="dropdown"
                   class="dropdown"
                   auto-fit-on-attach
                   fit-into="{{_getElement(boundTarget)}}"
                   no-overlap
                   dynamic-align
                   vertical-align="top"
                   opened="{{opened}}"
                   hover="{{hover}}"
                   no-cancel-on-outside-click="{{preventCancelOnOutsideClick}}"
                   allow-outside-scroll="{{allowOutsideScroll}}"
                   disabled$="{{disabled}}">
      <div class="dropdown-content">
        <template is="dom-if" if="{{searchMode}}" value="{{searchTerm::input}}">
          <input class="text-input input--search u-ml-- u-mb-- u-p--" type="text" value="{{searchTerm::input}}">
        </template>
        <iron-selector id="selector"
                       multi="{{multi}}"
                       selected={{selected}}
                       selected-values={{selectedValues}}
                       selected-items={{selectedItems}}
                       attr-for-selected="{{selectBy}}">
          <template is="dom-repeat" id="dropdownItems" items="{{items}}" filter="{{_computeFilter(searchTerm)}}" delay="100">
            <div class="dropdown-option" key="{{item.key}}" val="{{item.val}}" disabled$="{{item.disabled}}">{{item.val}}</div>
          </template>
        </iron-selector>
      </div>
    </iron-dropdown>
  </template>
</dom-module>
<script>
  Polymer({

    is: 'px-dropdown',

    properties: {

      items: {
        type: Array,
        notify: true,
        value: function () {
          return [];
        }
      },

      displayValue: {
        type: String,
        value: 'Select'
      },

      opened: {
        type: Boolean,
        value: false,
        notify: true
      },

      hover: {
        type: Boolean,
        value: false,
        notify: true
      },

      preventCancelOnOutsideClick: {
        type: Boolean,
        value: false
      },

      hideChevron: {
        type: Boolean,
        value: false
      },

      multi: {
        type: Boolean,
        value: false
      },

      boundTarget: {
        type: String
      },

      selectBy: {
        type: String,
        value: 'key'
      },

      selected: {
        type: (String|Number),
        value: null
      },

      selectedValues: {
        type: Array,
        value: function() {
          return [];
        }
      },

      selectedItems: {
        type: Array,
        value: function() {
          return [];
        }
      },

      allowOutsideScroll: {
        type: Boolean,
        value: false
      },

      bare: {
        type: Boolean,
        value: false
      },

      disabled: {
        type: Boolean,
        value: false
      },

      searchMode: {
        type: Boolean,
        value: false
      },

      searchTerm: {
        type: String,
        value: ''
      },
      sortMode: {
        type: String,
        observer: '_initSort'
      }
    },
    listeners: {
      'iron-select' : '_handleSelection',
      'iron-deselect' : '_handleDeselection'
    },
    observers: [
      '_itemsChanged(items, multi, selectBy, selectedValues)'
    ],
    toggle: function() {
      this.$.dropdown.toggle();
    },
    clear: function(evt) {
      evt.stopPropagation();
      var length = this.items.length,
          i;
      for(i=0; i<length; i++) {
        delete this.items[i].selected;
      }
      this.selected = null;
      this.selectedValues = [];
      this.$.dropdown.close();
    },
    attached: function() {
      this.$.dropdown.style.minWidth = window.getComputedStyle(this.$.button).width;
    },
    _getDisabledClass: function() {
      return this.disabled ? 'btn--disabled' : '';
    },
    _getBareClass: function() {
      return this.bare ? 'btn--bare' : '';
    },
    _getElement: function(target) {
      return document.querySelector(target);
    },
    _itemsChanged: function(items, multi, selectBy, selectedValues) {
      if(typeof items[0] === 'string') {
        var length = items.length,
            computedItems = [],
            i;
        for(i=0; i<length; i++) {
          computedItems[i] = {"key":i, "val":items[i]};
        }
        this.items = computedItems;
      }
      if(multi) {
        var length = items.length,
            i;
        for(i=0; i<length; i++) {
          if(items[i].selected !== undefined && items[i].selected.toString() === 'true') {
            this.push('selectedValues', items[i][selectBy]);
          }
        }
        if(this.selectedValues.length > 0) this.$.label.innerText = this.selectedValues.length + ' Selected';
      }
    },
    _handleSelection: function(evt) {
      if(this.multi && this.selectedItems.length === 1) {
        this.$.label.innerText = this.selectedItems[0].innerText;
      }
      else if(this.multi && this.selectedValues.length > 1) {
        this.$.label.innerText = this.selectedValues.length + ' Selected';
      }
      else {
        this.$.label.innerText = this.$.selector.selectedItem ? this.$.selector.selectedItem.innerText : this.displayValue;
        this.$.dropdown.close();
      }
    },
    _handleDeselection: function(evt) {
      if(this.multi && this.selectedItems.length === 1) {
        this.$.label.innerText = this.selectedItems[0].innerText;
      }
      else if(this.multi && this.selectedValues.length > 1) {
        this.$.label.innerText = this.selectedValues.length + ' Selected';
      }
      else {
        this.$.label.innerText = this.displayValue;
      }
    },
    _computeFilter: function (searchTerm) {
      return (!this.searchMode || !searchTerm.length) ? null : function (entry) { return entry.val.toLowerCase().indexOf(searchTerm.toLowerCase()) != -1; };

    },
    _showClearButton: function(opened, selected, selectedValues) {
      return (opened && (typeof selected === 'string' || typeof selected === 'number' || selectedValues.length > 0));
    },
    _showChevron: function(hideChevron, opened, selected, selectedValues) {
      return !hideChevron && (!opened || (opened && !selected && selectedValues.length === 0));
    },
    _initSort: function () {
      this.$.dropdownItems.sort = '_computeSort';
      this.$.dropdownItems.render();
    },
    _computeSort: function (a, b) {
      var sortValue = 0;
      if (!this.sortMode) {
        return -1;
      }

      if (this.sortMode && sortValue === 0) {
        if (this.sortMode === 'key') {
          sortValue = a.key - b.key;
        }
        if (this.sortMode === 'val') {
          var nameA = a.val.toUpperCase(),
            nameB = b.val.toUpperCase();

          if (nameA < nameB) {
            sortValue--;
          }
          if (nameA > nameB) {
            sortValue++;
          }
        }
      }

      return sortValue;
    },

  });
</script>
